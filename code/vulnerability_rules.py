import re

class VulnerabilityRules:
    """定义和识别潜在漏洞相关代码行的规则集合。
    包括内存操作、指针操作、缓冲区操作等常见漏洞类型的识别规则。
    """

    def __init__(self):
        # 内存相关漏洞模式
        self.memory_patterns = [
            r'malloc\s*\(',  # 内存分配
            r'free\s*\(',   # 内存释放
            r'realloc\s*\(',  # 内存重分配
            r'memcpy\s*\(',  # 内存复制
            r'memmove\s*\(',  # 内存移动
            r'memset\s*\(',  # 内存设置
            r'alloca\s*\('  # 栈上分配
        ]

        # 指针相关漏洞模式
        self.pointer_patterns = [
            r'\*\s*\w+',  # 指针解引用
            r'&\s*\w+',   # 取地址操作
            r'\w+\s*\[\s*\w+\s*\]',  # 数组索引
            r'->',  # 结构体指针访问
            r'NULL',  # NULL指针
            r'void\s*\*'  # void指针
        ]

        # 缓冲区相关漏洞模式
        self.buffer_patterns = [
            r'strcpy\s*\(',  # 字符串复制
            r'strcat\s*\(',  # 字符串拼接
            r'gets\s*\(',   # 不安全的输入
            r'sprintf\s*\(',  # 格式化字符串
            r'scanf\s*\(',   # 输入函数
            r'\w+\[\d+\]'  # 固定大小数组
        ]

        # 格式化字符串漏洞模式
        self.format_string_patterns = [
            r'printf\s*\(',
            r'fprintf\s*\(',
            r'snprintf\s*\(',
            r'vprintf\s*\(',
            r'vsprintf\s*\('
        ]

        # 整数相关漏洞模式
        self.integer_patterns = [
            r'\+\+|--',  # 自增自减
            r'\+=|-=|\*=|/=',  # 复合赋值
            r'\d+\s*[\+\-\*/%]\s*\d+',  # 整数运算
            r'unsigned|signed',  # 符号修饰符
            r'int\s+\w+\s*=\s*\d+'  # 整数初始化
        ]

        # 命令执行漏洞模式
        self.command_execution_patterns = [
            r'system\s*\(',
            r'exec\s*\(',
            r'popen\s*\(',
            r'execl\s*\(',
            r'execle\s*\(',
            r'execlp\s*\(',
            r'execv\s*\(',
            r'execvp\s*\('
        ]

        # 编译所有正则表达式
        self._compile_patterns()

    def _compile_patterns(self):
        """将所有正则表达式模式编译为正则表达式对象以提高性能"""
        self.memory_patterns = [re.compile(p) for p in self.memory_patterns]
        self.pointer_patterns = [re.compile(p) for p in self.pointer_patterns]
        self.buffer_patterns = [re.compile(p) for p in self.buffer_patterns]
        self.format_string_patterns = [re.compile(p) for p in self.format_string_patterns]
        self.integer_patterns = [re.compile(p) for p in self.integer_patterns]
        self.command_execution_patterns = [re.compile(p) for p in self.command_execution_patterns]

    def identify_vulnerable_lines(self, code_lines):
        """识别代码中的潜在漏洞行

        Args:
            code_lines: 代码行列表，每个元素是一行代码

        Returns:
            一个集合，包含所有可能包含漏洞的行号（从1开始）
        """
        vulnerable_lines = set()

        for line_num, line in enumerate(code_lines, 1):
            # 检查所有类型的漏洞模式
            if self._check_patterns(line, self.memory_patterns) or \
               self._check_patterns(line, self.pointer_patterns) or \
               self._check_patterns(line, self.buffer_patterns) or \
               self._check_patterns(line, self.format_string_patterns) or \
               self._check_patterns(line, self.integer_patterns) or \
               self._check_patterns(line, self.command_execution_patterns):
                vulnerable_lines.add(line_num)

        return vulnerable_lines

    def _check_patterns(self, line, patterns):
        """检查一行代码是否匹配给定的模式集合

        Args:
            line: 要检查的代码行
            patterns: 编译好的正则表达式模式列表

        Returns:
            如果找到匹配则返回True，否则返回False
        """
        return any(pattern.search(line) for pattern in patterns)